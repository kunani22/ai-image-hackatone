<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Landscape Generator</title>
    <style>
        @font-face {
            font-family: 'Recoleta Black';
            src: url('recoleta-black.otf') format('opentype');
            font-weight: 900;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #000;
            overflow: hidden;
            position: relative;
        }

        .container {
            display: none;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffd89b, #19547b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            margin-top: 2rem;
        }

        .spinner {
            border: 4px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top: 4px solid #000;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            z-index: 1000;
            background: #fff;
        }

        .generated-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .generated-image.loaded {
            opacity: 1;
        }

        .image-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            text-align: center;
            color: white;
            font-family: 'Recoleta Black', serif;
            font-size: 8rem;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            max-width: 90vw;
            line-height: 1.1;
        }

        .editable-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            text-align: center;
            color: #000;
            font-family: 'Recoleta Black', serif;
            font-size: 8rem;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            max-width: 90vw;
            line-height: 1.1;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            overflow: hidden;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .editable-title::placeholder {
            color: inherit;
            opacity: 0.7;
        }
        
        .editable-title:focus {
            cursor: text;
        }

        .image-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            text-align: center;
            color: white;
            font-family: 'Recoleta Black', serif;
            font-size: 8rem;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            max-width: 90vw;
            line-height: 1.1;
            transition: color 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .image-title:hover {
            opacity: 0.8;
        }

        .prompt-info-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            font-family: 'Recoleta Black', serif;
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
            display: none;
            z-index: 1003;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            text-transform: lowercase;
        }
        
        .settings-btn {
            display: none; /* API í‚¤ê°€ ì„œë²„ì—ì„œ ê´€ë¦¬ë˜ë¯€ë¡œ ì„¤ì • UI ìˆ¨ê¹€ */
        }

        .prompt-info-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .settings-btn:hover {
            background: transparent;
            color: transparent;
            opacity: 0;
        }

        .instructions {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 0, 0, 0.6);
            font-size: 1.2rem;
            text-align: center;
            z-index: 1001;
            transition: color 0.3s ease;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            color: #000;
            backdrop-filter: blur(10px);
        }

        .generated-image.loading {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .error-message {
            background: rgba(255,82,82,0.2);
            border: 1px solid rgba(255,82,82,0.5);
            color: #ff5252;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
            backdrop-filter: blur(10px);
        }

        .info {
            margin-top: 2rem;
            opacity: 0.7;
            font-size: 0.9rem;
            max-width: 600px;
            line-height: 1.6;
        }

        .prompt-display {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-50px) rotate(180deg); }
        }

        @media (max-width: 768px) {
            .image-title, .editable-title {
                font-size: 5rem;
                letter-spacing: 0.5px;
            }
            
            .instructions {
                font-size: 1rem;
                bottom: 30px;
            }
        }

        .prompt-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1004;
            align-items: flex-start;
            justify-content: center;
            padding-top: 80px;
            backdrop-filter: blur(5px);
        }

        .prompt-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80vw;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .prompt-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .prompt-close:hover {
            background: #f0f0f0;
            color: #000;
        }

        .prompt-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .prompt-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .user-prompt {
            color: #2563eb;
            font-weight: 600;
        }

        .system-prompt {
            color: #666;
        }

        @media (max-width: 768px) {
            .prompt-content {
                max-width: 95vw;
                padding: 20px;
            }
            
            .prompt-title {
                font-size: 1.4rem;
            }
            
            .prompt-text {
                font-size: 1rem;
            }
            
            .prompt-info-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1005;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .settings-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90vw;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .settings-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            transition: border-color 0.3s ease;
        }

        .settings-input:focus {
            outline: none;
            border-color: #03C75A;
            box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.1);
        }

        .settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .settings-btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn-save {
            background: #03C75A;
            color: white;
        }

        .settings-btn-save:hover {
            background: #02b050;
        }

        .settings-btn-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .settings-btn-cancel:hover {
            background: #e0e0e0;
        }

        .settings-note {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            line-height: 1.4;
        }

        @media (max-width: 480px) {
            .image-title, .editable-title {
                font-size: 3.5rem;
                letter-spacing: 0px;
            }
            
            .instructions {
                font-size: 0.9rem;
                bottom: 20px;
            }
            
            .settings-content {
                padding: 20px;
                width: 95vw;
            }
            
            .settings-title {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="container">
        <h1>Summer Landscape</h1>
        <p class="subtitle">AI-Powered Beautiful Scenery Generator</p>
        
        <button class="generate-btn" id="generateBtn">
            Generate Summer Landscape
        </button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Creating your beautiful summer landscape...</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="prompt-display">
            <strong>Prompt:</strong> "A breathtaking summer landscape with rolling green hills, vibrant wildflowers, crystal clear blue sky with fluffy white clouds, golden sunlight filtering through trees, peaceful meadow, photorealistic, high quality, detailed"
        </div>
        
        <div class="info">
            <p>Click the button above to generate a stunning AI-created summer landscape using FLUX Pro v1.1 Ultra model. The generated image will be displayed in fullscreen for the best viewing experience.</p>
        </div>
    </div>
    
    <div class="image-container" id="imageContainer">
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; font-size: 1.2rem; color: #000;" id="loadingText">Creating your image...</p>
        </div>
        <img class="generated-image" id="generatedImage" alt="Generated Landscape" style="display: none;">
        <div class="image-title" id="imageTitle" style="display: none;"></div>
        <textarea class="editable-title" id="editableTitle" placeholder="">Fill the browser</textarea>
        <div class="instructions">Type your image description above and press Enter to generate</div>
        
        <!-- í”„ë¡¬í”„íŠ¸ ì •ë³´ ë²„íŠ¼ -->
        <button class="prompt-info-btn" id="promptInfoBtn" style="display: none;">i</button>
        
        <!-- ì„¤ì • ë²„íŠ¼ -->
        <button class="settings-btn" id="settingsBtn">âš™</button>
    </div>

    <!-- í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ -->
    <div class="prompt-modal" id="promptModal">
        <div class="prompt-content">
            <button class="prompt-close" id="promptClose">Ã—</button>
            <div class="prompt-title">Full Prompt Used for Generation</div>
            <div class="prompt-text" id="promptText"></div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-title">API Settings</div>
            
            <div class="settings-group">
                <label class="settings-label" for="falApiKey">fal.ai API Key</label>
                <input type="password" class="settings-input" id="falApiKey" placeholder="Enter your fal.ai API key">
                <div class="settings-note">Your fal.ai API key for FLUX image generation. Get it from <a href="https://fal.ai" target="_blank">fal.ai</a></div>
            </div>
            
            <div class="settings-group">
                <label class="settings-label" for="openaiApiKey">OpenAI API Key</label>
                <input type="password" class="settings-input" id="openaiApiKey" placeholder="Enter your OpenAI API key">
                <div class="settings-note">Your OpenAI API key for prompt enhancement. Get it from <a href="https://platform.openai.com" target="_blank">OpenAI Platform</a></div>
            </div>
            
            <div class="settings-buttons">
                <button class="settings-btn-action settings-btn-cancel" id="settingsCancel">Cancel</button>
                <button class="settings-btn-action settings-btn-save" id="settingsSave">Save</button>
            </div>
        </div>
    </div>

    <script>
        // APIê°€ ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ì²˜ë¦¬ë¨ (API í‚¤ ìˆ¨ê¹€)
        const USE_LOCAL_API = true; // í”„ë¡œë•ì…˜ì—ì„œëŠ” true, ê°œë°œì‹œ falseë¡œ ë³€ê²½ ê°€ëŠ¥
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const imageContainer = document.getElementById('imageContainer');
        const generatedImage = document.getElementById('generatedImage');
        const imageTitle = document.getElementById('imageTitle');
        const editableTitle = document.getElementById('editableTitle');
        const loadingText = document.getElementById('loadingText');
        const instructions = document.querySelector('.instructions');
        const promptInfoBtn = document.getElementById('promptInfoBtn');
        const promptModal = document.getElementById('promptModal');
        const promptClose = document.getElementById('promptClose');
        const promptText = document.getElementById('promptText');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsCancel = document.getElementById('settingsCancel');
        const settingsSave = document.getElementById('settingsSave');
        const falApiKeyInput = document.getElementById('falApiKey');
        const openaiApiKeyInput = document.getElementById('openaiApiKey');
        
        // í˜„ì¬ ìƒì„±ëœ ì´ë¯¸ì§€ì˜ ì „ì²´ í”„ë¡¬í”„íŠ¸ ì €ì¥
        let currentFullPrompt = '';
        let originalPrompt = ''; // ì´ë¯¸ì§€ ìƒì„± ì‹œ ì‚¬ìš©ëœ ì›ë³¸ í”„ë¡¬í”„íŠ¸
        
        // OpenAIë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ì°½ì˜ì ìœ¼ë¡œ í™•ì¥í•˜ëŠ” í•¨ìˆ˜
        async function enhancePromptWithAI(userInput) {
            try {
                console.log('ğŸ¯ Transforming input into cinematic masterpiece...');
                
                // ì „ë¬¸ê°€ê¸‰ í”„ë¡¬í”„íŠ¸ ì¦ê°•ì„ ìœ„í•´ ì„œë²„ë¡œ ì „ì†¡
                const response = await fetch('/api/enhance-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userInput
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const enhancedPrompt = data.enhancedPrompt;
                
                console.log('Original:', userInput);
                console.log('Enhanced:', enhancedPrompt);
                
                return enhancedPrompt;
                
            } catch (error) {
                console.error('Error enhancing prompt:', error);
                // í´ë°±: ê¸°ë³¸ í‚¤ì›Œë“œë§Œ ì¶”ê°€
                return `${userInput}, high quality, detailed, beautiful composition`;
            }
        }
        
        // ì´ë¯¸ì§€ì˜ í‰ê·  ë°ê¸°ë¥¼ ê³„ì‚°í•˜ì—¬ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì •
        function getOptimalTextColor(imageElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 100; // ìƒ˜í”Œë§ì„ ìœ„í•´ ì‘ì€ í¬ê¸° ì‚¬ìš©
            canvas.height = 100;
            
            ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let r = 0, g = 0, b = 0;
            let pixelCount = 0;
            
            // ì¤‘ì•™ ì˜ì—­ì˜ í”½ì…€ë“¤ë§Œ ìƒ˜í”Œë§ (í…ìŠ¤íŠ¸ê°€ ìœ„ì¹˜í•  ì˜ì—­)
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const sampleRadius = 30;
            
            for (let y = centerY - sampleRadius; y < centerY + sampleRadius; y++) {
                for (let x = centerX - sampleRadius; x < centerX + sampleRadius; x++) {
                    if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                        const index = (y * canvas.width + x) * 4;
                        r += data[index];
                        g += data[index + 1];
                        b += data[index + 2];
                        pixelCount++;
                    }
                }
            }
            
            r = Math.floor(r / pixelCount);
            g = Math.floor(g / pixelCount);
            b = Math.floor(b / pixelCount);
            
            // ë°ê¸° ê³„ì‚° (0-255)
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // ë°ê¸°ì— ë”°ë¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì •
            return brightness > 128 ? '#000' : '#fff';
        }
        
        // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        function updateTextColor(color) {
            imageTitle.style.color = color;
        }
        
        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 4 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 6 + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        async function generateImage(prompt) {
            try {
                // í¸ì§‘ ëª¨ë“œ ìˆ¨ê¸°ê¸°
                editableTitle.style.display = 'none';
                instructions.style.display = 'none';
                promptInfoBtn.style.display = 'none';
                imageTitle.style.display = 'none';
                
                // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¸”ëŸ¬ ì²˜ë¦¬, ì—†ìœ¼ë©´ í° ë°°ê²½
                if (generatedImage.style.display === 'block') {
                    generatedImage.classList.add('loading');
                    loadingOverlay.style.background = 'rgba(255, 255, 255, 0.3)';
                } else {
                    loadingOverlay.style.background = '#fff';
                }
                
                loadingOverlay.style.display = 'flex';
                loadingText.textContent = `Enhancing your prompt with AI...`;
                
                // OpenAIë¡œ í”„ë¡¬í”„íŠ¸ ì°½ì˜ì  í™•ì¥
                const enhancedPrompt = await enhancePromptWithAI(prompt);
                currentFullPrompt = enhancedPrompt;
                
                loadingText.textContent = `Creating "${prompt}"...`;
                
                // ë¡œì»¬ API ì„œë²„ë¥¼ í†µí•´ ì´ë¯¸ì§€ ìƒì„±
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: enhancedPrompt
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.images && result.images.length > 0) {
                    displayImage(result.images[0].url, prompt, enhancedPrompt);
                } else {
                    throw new Error('No image generated');
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                // ì—ëŸ¬ ì‹œ ë¸”ëŸ¬ ì œê±°
                generatedImage.classList.remove('loading');
                loadingOverlay.innerHTML = `
                    <div style="text-align: center;">
                        <h2 style="color: #ff5252; margin-bottom: 1rem;">ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨</h2>
                        <p style="color: #ccc;">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }
        
        function displayImage(imageUrl, prompt, enhancedPrompt) {
            generatedImage.src = imageUrl;
            generatedImage.onload = function() {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                loadingOverlay.style.display = 'none';
                generatedImage.classList.remove('loading');
                generatedImage.style.display = 'block';
                generatedImage.classList.add('loaded');
                imageTitle.textContent = prompt.toUpperCase();
                
                // í™•ì¥ëœ í”„ë¡¬í”„íŠ¸ì™€ ì›ë³¸ í”„ë¡¬í”„íŠ¸ ì €ì¥
                currentFullPrompt = enhancedPrompt;
                originalPrompt = prompt;
                
                // ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê³„ì‚°
                setTimeout(() => {
                    const optimalColor = getOptimalTextColor(generatedImage);
                    updateTextColor(optimalColor);
                }, 100);
                
                imageTitle.style.display = 'block';
                promptInfoBtn.style.display = 'flex';
            };
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        editableTitle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const prompt = editableTitle.value.trim();
                if (prompt) {
                    generateImage(prompt);
                }
            }
        });
        
        // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        function switchToEditMode(currentText = null) {
            // í˜„ì¬ imageTitleì˜ ìƒ‰ìƒì„ ì €ì¥
            const currentColor = window.getComputedStyle(imageTitle).color;
            
            // ì´ë¯¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³  í…ìŠ¤íŠ¸ë§Œ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            imageTitle.style.display = 'none';
            editableTitle.style.display = 'block';
            instructions.style.display = 'block';
            
            // ì €ì¥ëœ ìƒ‰ìƒì„ editableTitleì— ì ìš©
            editableTitle.style.color = currentColor;
            // instructions ìƒ‰ìƒë„ ê°™ì€ ìƒ‰ìƒ ê³„ì—´ë¡œ ì„¤ì • (íˆ¬ëª…ë„ë§Œ ì¡°ì •)
            const isWhite = currentColor.includes('rgb(255, 255, 255)') || currentColor.includes('white');
            instructions.style.color = isWhite ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)';
            
            if (currentText) {
                editableTitle.value = currentText;
            }
            editableTitle.focus();
            editableTitle.style.height = 'auto';
            editableTitle.style.height = editableTitle.scrollHeight + 'px';
        }
        
        // í¸ì§‘ ëª¨ë“œì—ì„œ ë²—ì–´ë‚˜ëŠ” í•¨ìˆ˜
        function exitEditMode() {
            editableTitle.style.display = 'none';
            instructions.style.display = 'none';
            imageTitle.style.display = 'block';
            
            // ì›ë³¸ í”„ë¡¬í”„íŠ¸ë¡œ ë˜ëŒë¦¬ê¸°
            if (originalPrompt) {
                imageTitle.textContent = originalPrompt.toUpperCase();
                editableTitle.value = originalPrompt;
            }
        }
        
        // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ë‹¤ì‹œ í¸ì§‘ ëª¨ë“œë¡œ
        generatedImage.addEventListener('click', function() {
            switchToEditMode();
        });
        
        // í…ìŠ¤íŠ¸ í´ë¦­ ì‹œ í¸ì§‘ ëª¨ë“œë¡œ (ê¸°ì¡´ í…ìŠ¤íŠ¸ì™€ í•¨ê»˜)
        imageTitle.addEventListener('click', function(e) {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            const currentText = originalPrompt || imageTitle.textContent.toLowerCase();
            switchToEditMode(currentText);
        });
        
        // ìë™ ë†’ì´ ì¡°ì ˆ
        editableTitle.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // í¬ì»¤ìŠ¤ ì‹œ í…ìŠ¤íŠ¸ í´ë¦¬ì–´
        editableTitle.addEventListener('focus', function() {
            if (this.value === 'Fill the browser') {
                this.value = '';
            }
        });
        
        // í¬ì»¤ìŠ¤ í•´ì œ ì‹œ í…ìŠ¤íŠ¸ ë³µì›
        editableTitle.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.value = 'Fill the browser';
            }
        });
        
        // í”„ë¡¬í”„íŠ¸ ì •ë³´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        promptInfoBtn.addEventListener('click', function() {
            const userPrompt = imageTitle.textContent.toLowerCase();
            const aiEnhancedPart = currentFullPrompt.replace(userPrompt, '').replace(/^,\s*/, '');
            
            promptText.innerHTML = `<span class="user-prompt">${userPrompt}</span><span class="system-prompt">, ${aiEnhancedPart}</span>`;
            promptModal.style.display = 'flex';
        });
        
        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ë“¤
        promptClose.addEventListener('click', function() {
            promptModal.style.display = 'none';
        });
        
        promptModal.addEventListener('click', function(e) {
            if (e.target === promptModal) {
                promptModal.style.display = 'none';
            }
        });
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (promptModal.style.display === 'flex') {
                    promptModal.style.display = 'none';
                }
                if (settingsModal.style.display === 'flex') {
                    closeSettings();
                }
            }
        });
        
        // í…ìŠ¤íŠ¸ ì˜ì—­ ì™¸ë¶€ í´ë¦­ ì‹œ í¸ì§‘ ëª¨ë“œ ë²—ì–´ë‚˜ê¸°
        document.addEventListener('click', function(e) {
            // í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆê³ , ì´ë¯¸ì§€ê°€ í‘œì‹œëœ ìƒíƒœì—ì„œë§Œ ì‘ë™
            if (editableTitle.style.display === 'block' && generatedImage.style.display === 'block') {
                // í´ë¦­ëœ ìš”ì†Œê°€ í¸ì§‘ ê´€ë ¨ ìš”ì†Œê°€ ì•„ë‹Œ ê²½ìš°
                if (!editableTitle.contains(e.target) && 
                    !instructions.contains(e.target) && 
                    e.target !== editableTitle && 
                    e.target !== instructions &&
                    e.target !== imageTitle) { // imageTitle í´ë¦­ì€ ì œì™¸
                    exitEditMode();
                }
            }
        });
        
        // ESC í‚¤ë¡œë„ í¸ì§‘ ëª¨ë“œ ë²—ì–´ë‚˜ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && editableTitle.style.display === 'block' && generatedImage.style.display === 'block') {
                exitEditMode();
            }
        });
        
        // ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openSettings() {
            // í˜„ì¬ ì €ì¥ëœ API í‚¤ë“¤ì„ ì…ë ¥ í•„ë“œì— í‘œì‹œ (ë§ˆìŠ¤í‚¹)
            falApiKeyInput.value = FAL_API_KEY ? 'â€¢'.repeat(20) + FAL_API_KEY.slice(-10) : '';
            openaiApiKeyInput.value = OPENAI_API_KEY ? 'â€¢'.repeat(20) + OPENAI_API_KEY.slice(-10) : '';
            settingsModal.style.display = 'flex';
        }
        
        function closeSettings() {
            settingsModal.style.display = 'none';
        }
        
        function saveSettings() {
            // ìƒˆë¡œìš´ í‚¤ê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë§ˆìŠ¤í‚¹ë˜ì§€ ì•Šì€ ê°’)
            const newFalKey = falApiKeyInput.value.trim();
            const newOpenaiKey = openaiApiKeyInput.value.trim();
            
            if (newFalKey && !newFalKey.startsWith('â€¢')) {
                FAL_API_KEY = newFalKey;
                localStorage.setItem('fal_api_key', FAL_API_KEY);
            }
            
            if (newOpenaiKey && !newOpenaiKey.startsWith('â€¢')) {
                OPENAI_API_KEY = newOpenaiKey;
                localStorage.setItem('openai_api_key', OPENAI_API_KEY);
            }
            
            closeSettings();
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #03C75A;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            successMsg.textContent = 'API Keys saved successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
        
        // ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        settingsBtn.addEventListener('click', openSettings);
        settingsCancel.addEventListener('click', closeSettings);
        settingsSave.addEventListener('click', saveSettings);
        
        settingsModal.addEventListener('click', function(e) {
            if (e.target === settingsModal) {
                closeSettings();
            }
        });
        
        // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ê¸°ì¡´ ê°’ í´ë¦¬ì–´ (ìƒˆë¡œìš´ í‚¤ ì…ë ¥ì„ ìœ„í•´)
        falApiKeyInput.addEventListener('focus', function() {
            if (this.value.startsWith('â€¢')) {
                this.value = '';
            }
        });
        
        openaiApiKeyInput.addEventListener('focus', function() {
            if (this.value.startsWith('â€¢')) {
                this.value = '';
            }
        });
        
        // ì´ˆê¸° í¬ì»¤ìŠ¤
        window.addEventListener('load', function() {
            editableTitle.style.height = editableTitle.scrollHeight + 'px';
        });
        
        console.log('Interactive Image Generator with Prompt Viewer loaded successfully!');
    </script>
</body>
</html>